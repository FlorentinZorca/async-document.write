(function(){var n=0,o=0,j=[],d,k=!1,c=function(a){k&&console.log&&console.log("Calls:"+n+", Queue:"+j.length+", "+a)},h=function(a,c){setTimeout(function(){a()},c?c:100)},p=function(a){d&&(d.content+=a,c(" <- Appended to queue for "+d.hookNode.id+": "+a))},r=function(a,b,g){var q="hook-"+o++,e=document.createElement("span");e.id=q;a.appendChild(e);a={hookNode:e,scriptNode:b,contentType:"html",content:g};j.push(a);d=a;c(" <- Queued write to "+q+": "+g)},t=function(a,b){var g=!1,e=function(a,c){var f=
document.createElement("script");f.type="text/javascript";f.text=c;a.appendChild(f);return f},k=function(a,d){g=!0;c("Asynch script: "+d);$.ajax({url:d,dataType:"script",async:!0,timeout:2E3,complete:function(a,e){c(e+": loaded "+d);b&&b()}})},h=function(a,e){var f=document.createElement("span"),b,g,l,k;f.innerHTML="&nbsp;"+e;f.id=a.id+"-inj";g=f.getElementsByTagName("script");for(k=0;0<g.length;){b=l=g[0];var i=a.id+"-s-"+k++,h=b.parentNode,m=void 0,m=document.createElement("span");m.id=i?i:"hook-"+
o++;h.replaceChild(m,b)||(h.removeChild(b),h.appendChild(m));b=m;l.src?(i={hookNode:b,contentType:"script-extern",content:l.src},j.push(i),d=i,c(" <- Queued external script to "+b.id+": "+l.src)):(i={hookNode:b,contentType:"script-inline",content:l.text},j.push(i),d=i,c(" <- Queued inline script to "+b.id+": "+l.text))}f.innerHTML&&(f.removeChild(f.childNodes[0]),a.appendChild(f),c(" -> Injected static html to "+a.id+": id = "+f.id+", content = "+f.innerHTML))};a?a.hookNode&&a.content?"html"===a.contentType?
h(a.hookNode,a.content):(r(a.hookNode,null,"<\!-- "+a.hookNode.id+" script --\>"),document.write=function(){var b;arguments.length&&(n++,b=Array.prototype.slice.call(arguments).join(""),p(b),c(" <- Appended to context implant "+a.hookNode.id+": "+b))},"script-inline"===a.contentType?e(a.hookNode,a.content):k(a.hookNode,a.content)):c("Could not find hook node "+a.hookNode?a.hookNode.id:"NULL"):c("No implant?");g&&c("Asynch scripts spawned.");!g&&b&&(c("Calling back after pure inline content."),b())},
s=function(){var a;0<j.length?(c("Dequeuing"),d=a=j.shift(),t(a,function(){0<j.length?(c(a.hookNode.id+" done. Dequeue next one."),h(s)):(c(a.hookNode.id+" done. It was the last queue item."),d=null)})):c("Dequeue from empty queue.")},e={write:function(){var a,b,c;if(arguments.length){n++;c=Array.prototype.slice.call(arguments).join("");a=document.getElementsByTagName("script");0<a.length&&(b=a[a.length-1]);a=b.parentNode;var e=d?d.scriptNode?d.scriptNode:d.hookNode:null;!b||e===b?p(c):r(a,b,c)}},
applyWrite:function(){h(s)},enableLogging:function(){k=!0}};document.write=e.write;document.applyWrite=e.applyWrite;window.asyncWrite=e;"function"===typeof define&&define.amd&&define("async-document.write",function(){return e});return e})(window);
