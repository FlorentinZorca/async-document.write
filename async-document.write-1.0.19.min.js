(function(){var m=0,n=0,k=[],c,e=function(a){console.log("Calls:"+m+", Queue:"+k.length+", "+a)},l=function(a,d){setTimeout(function(){a()},d?d:100)},o=function(a,d){var h=c?c.scriptNode?c.scriptNode:c.hookNode:null;if(!a||h===a)c&&(c.content+=d,e(" <- Appended to queue for "+c.hookNode.id+": "+d));else{var h="hook-"+n++,b=a.parentNode,i=document.createElement("span");i.id=h;b.appendChild(i);b={hookNode:i,scriptNode:a,contentType:"html",content:d};k.push(b);c=b;e(" <- Queued write to "+h+": "+d)}},
r=function(a,d){var h=!1,b=0,i=function(a,d){var f=document.createElement("script");f.type="text/javascript";f.text=d;a.appendChild(f);return f},g=function(a,c){h=!0;b++;e(b+". Asynch script: "+c);$.ajax({url:c,dataType:"script",async:!0,timeout:2E3,complete:function(a,q){b--;e(q+": loaded "+c+", still to load: "+b);0===b&&(console.log("Finished joining asynchronous script loading, now calling back."),d&&d())}})},l=function(a,d){var f=document.createElement("span"),b,h,g;f.innerHTML="&nbsp;"+d;f.id=
a.id+"-inj";for(h=f.getElementsByTagName("script");0<h.length;){b=g=h[0];var j=b.parentNode,i=void 0,i=document.createElement("span");i.id="hook-"+n++;j.replaceChild(i,b)||(j.removeChild(b),j.appendChild(i));b=i;g.src?(j={hookNode:b,contentType:"script-extern",content:g.src},k.push(j),c=j,e(" <- Queued external script to "+b.id+": "+g.src)):(j={hookNode:b,contentType:"script-inline",content:g.text},k.push(j),c=j,e(" <- Queued inline script to "+b.id+": "+g.text))}f.innerHTML&&(f.removeChild(f.childNodes[0]),
a.appendChild(f),e(" -> Injected static html to "+a.id+": id = "+f.id+", content = "+f.innerHTML))};if(a)if(a.hookNode&&a.content)switch(document.write=function(){var b;arguments.length&&(m++,b=Array.prototype.slice.call(arguments).join(""),o(a.hookNode,b),e(" <- Appended to context implant "+a.hookNode.id+": "+b))},a.contentType){case "script-inline":i(a.hookNode,a.content);break;case "script-extern":g(a.hookNode,a.content);break;case "html":l(a.hookNode,a.content)}else e("Could not find hook node "+
a.hookNode?a.hookNode.id:"NULL");else e("No implant?");console.log("Asynch scripts spawned "+b);!h&&d&&(console.log("Calling back after pure inline content."),d())},p=function(){var a;0<k.length?(e("Dequeuing"),a=k.shift(),r(a,function(){0<k.length?(e(a.hookNode.id+" done. Dequeue next one."),l(p)):(e(a.hookNode.id+" done. It was the last queue item."),c=null)})):e("Dequeue from empty queue.")},g={write:function(){var a,d,c;arguments.length&&(m++,c=Array.prototype.slice.call(arguments).join(""),a=
document.getElementsByTagName("script"),0<a.length&&(d=a[a.length-1]),o(d,c))},applyWrite:function(){l(p)}};document.write=g.write;document.applyWrite=g.applyWrite;"function"===typeof define&&define.amd&&define("asyncWrite",function(){return g});return g})(window);
