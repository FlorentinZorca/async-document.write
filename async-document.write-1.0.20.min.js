(function(){var n=0,o=0,j=[],d,l=!1,c=function(a){l&&console.log&&console.log("Calls:"+n+", Queue:"+j.length+", "+a)},m=function(a,c){setTimeout(function(){a()},c?c:100)},p=function(a,b){var g=d?d.scriptNode?d.scriptNode:d.hookNode:null;if(!a||g===a)d&&(d.content+=b,c(" <- Appended to queue for "+d.hookNode.id+": "+b));else{var g="hook-"+o++,e=a.parentNode,f=document.createElement("span");f.id=g;e.appendChild(f);e={hookNode:f,scriptNode:a,contentType:"html",content:b};j.push(e);d=e;c(" <- Queued write to "+
g+": "+b)}},r=function(a,b){var g=!1,e=0,f=function(a,c){var h=document.createElement("script");h.type="text/javascript";h.text=c;a.appendChild(h);return h},l=function(a,d){g=!0;e++;c(e+". Asynch script: "+d);$.ajax({url:d,dataType:"script",async:!0,timeout:2E3,complete:function(a,f){e--;c(f+": loaded "+d+", still to load: "+e);0===e&&(c("Finished joining asynchronous script loading, now calling back."),b&&b())}})},m=function(a,f){var h=document.createElement("span"),b,e,g;h.innerHTML="&nbsp;"+f;
h.id=a.id+"-inj";for(e=h.getElementsByTagName("script");0<e.length;){b=g=e[0];var i=b.parentNode,k=void 0,k=document.createElement("span");k.id="hook-"+o++;i.replaceChild(k,b)||(i.removeChild(b),i.appendChild(k));b=k;g.src?(i={hookNode:b,contentType:"script-extern",content:g.src},j.push(i),d=i,c(" <- Queued external script to "+b.id+": "+g.src)):(i={hookNode:b,contentType:"script-inline",content:g.text},j.push(i),d=i,c(" <- Queued inline script to "+b.id+": "+g.text))}h.innerHTML&&(h.removeChild(h.childNodes[0]),
a.appendChild(h),c(" -> Injected static html to "+a.id+": id = "+h.id+", content = "+h.innerHTML))};if(a)if(a.hookNode&&a.content)switch(document.write=function(){var b;arguments.length&&(n++,b=Array.prototype.slice.call(arguments).join(""),p(a.hookNode,b),c(" <- Appended to context implant "+a.hookNode.id+": "+b))},a.contentType){case "script-inline":f(a.hookNode,a.content);break;case "script-extern":l(a.hookNode,a.content);break;case "html":m(a.hookNode,a.content)}else c("Could not find hook node "+
a.hookNode?a.hookNode.id:"NULL");else c("No implant?");c("Asynch scripts spawned "+e);!g&&b&&(c("Calling back after pure inline content."),b())},q=function(){var a;0<j.length?(c("Dequeuing"),a=j.shift(),r(a,function(){0<j.length?(c(a.hookNode.id+" done. Dequeue next one."),m(q)):(c(a.hookNode.id+" done. It was the last queue item."),d=null)})):c("Dequeue from empty queue.")},f={write:function(){var a,b,c;arguments.length&&(n++,c=Array.prototype.slice.call(arguments).join(""),a=document.getElementsByTagName("script"),
0<a.length&&(b=a[a.length-1]),p(b,c))},applyWrite:function(){m(q)},enableLogging:function(){l=!0}};document.write=f.write;document.applyWrite=f.applyWrite;window.asyncWrite=f;"function"===typeof define&&define.amd&&define("asyncWrite",function(){return f});return f})(window);
